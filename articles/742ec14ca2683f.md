---
title: "続・Cloudflareのアカウント間でWebサイトを移行する"
emoji: "⛅️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["cloudflare"]
published: true
---

# ここでやりたいこと

> - 2つのCloudflareアカウント、AとBがあります。
> - Aには複数のWebサイト（ドメイン）があります。
> - Aのうち1つ以上のWebサイトをBに移行しようとしています。
> - 今回は _アカウントA_ にある _Webサイトα_ を _アカウントB_ に移行したいと考えています。

# 移行ツールが提供されました👏

Cloudflareアカウント間でサイト（ドメイン）の移行が容易になりました🎉

https://developers.cloudflare.com/registrar/account-options/inter-account-transfer/

[前回の記事](./352fec9b2311a2)を書いたときは、直接の移行はできませんでした。
> Cloudflareに移管したドメインを別のCloudflareアカウントに移行するには、
> 一度外部のレジストラにドメインを移管し、移管ロック解除を待って目的のCloudflareアカウントに再度移管する。

という時間と手間と、ドメイン移管更新費用がかかり、大変な移管作業が必要でした。


## できること

- ドメイン登録のアカウント間移行
- DNSのゾーンの移管（手動）
- ネームサーバーの切り替え

## おそらくできないこと

今回検証してないため分からないですが、PagesやWorkers、R2などのCloudflareサービスの移行までは行われないと思われます。


# ざっくりした手順

1. 移行元アカウントで対象ドメインのDNSレコードのエクスポート
2. 移行先アカウントで対象ドメインのWebサイト登録
   - 1でエクスポートしたDNSレコードのファイルをそのまま使用します
3. 移行先アカウントのアカウントIDをコピーする
4. 移行元アカウントで対象ドメインの移動に関する同意と操作
   - 先ほどコピーした移行先アカウントIDを入力
5. 移行先アカウントのメールアドレス宛に届くCloudflareからのメールのURLをクリックし、受入を同意

## 移行先で準備するもの

- アカウントの作成
  - Cloudflareから受信可能なメールアドレス
- アカウントID
- 対象ドメイン受入のためWebサイトの作成
  - 必要に応じてDNSレコードの受渡

## 移行元で準備すること

- 移行先のアカウントID
- 移行先に渡すDNSレコードの出力（エクスポート）


# 実際の操作手順


## 1. DNSレコードのエクスポート

先に移行したいドメインのDNSレコードをエクスポートしておきます。エクスポートはDNS管理画面の上部にあります。
![インポートとエクスポート選択画面.png](/images/742ec14ca2683f/export_dns_record1.png)

ポップアップが表示されるので、エクスポートを選択すると、現在のDNSレコードのゾーンファイルがダウンロードできます。
![インポートとエクスポートダイアログ.png](/images/742ec14ca2683f/export_dns_record2.png)

## 2. 移行先アカウントの準備とWebサイトの登録

移行先となるCloudflareアカウントの作成がまだの場合、新規登録を行います。

移行先アカウントでウェブサイトの登録を行います。
ウェブサイトの登録は今回移行したいドメインを指定し、追加する形となります。
今回はDNSレコードのゾーンファイルがあるため、移行方法に「DNSゾーン ファイルをアップロードする」を選択します。
![サイト登録画面.png](/images/742ec14ca2683f/create_web1.png)

プラン選択は必要に応じて選択します。今回はフリープランを選択しました。
![プラン選択画面.png](/images/742ec14ca2683f/create_web2.png)

続けて、DNSファイルのアップロード画面が出てくるので、先ほどエクスポートしたファイルをそのままアップロードします。
![DNSファイルインポート画面.png](/images/742ec14ca2683f/create_web3.png)

アップロードすると、取込ができなかったレコードについてエラーが表示されます。

::: message
今回はNSレコードが含まれていた旨のエラーが出ていますが、ここで無視されたNSは新しいアカウント側で自動で設定されるため問題ありません。
:::

::: message
他のエラーがあった場合はサイト登録完了後に、適宜手動で調整してください。
:::
![取込結果画面.png](/images/742ec14ca2683f/create_web4.png)

最後にレコード設定画面が表示されます。修正が必要な場合は適宜手動で編集し、アクティベーションに進みます。
![DNSレコードの編集画面.png](/images/742ec14ca2683f/create_web5.png)

ネームサーバーを変更する旨のアナウンスが表示されますが、このあとのドメイン移行で自動的に行われるため、ここでは一旦スルーします。
![ネームサーバー指定に関する案内.png](/images/742ec14ca2683f/create_web6.png)

最後に、画面右側に表示されている**API**の項目から***アカウントID**をコピー*しておきます。
これは後ほどアカウントの移行作業で使用します。
![アカウントID.png](/images/742ec14ca2683f/accountid.png)



## 3. 移行元アカウント側での作業
サイドメニュー内の「ドメイン登録」→「ドメインの管理」から対象のドメイン右側にある「管理」のリンクをクリックし、ドメインの管理に進みます。

ドメインの管理で「構成」タブを選択すると下の方に「別のCloudflare アカウントに移動する」という項目があるのでここで「開始」ボタンを押します。
![ドメインのアカウント移行開始画面.png](/images/742ec14ca2683f/migrate1.png)
あるいは、右側サイドメニューのクイック アクションにある「別のアカウントに移動する」を選択します。
![クイックアクションから開始する場合.png](/images/742ec14ca2683f/migrate_quickaction.png)

するとドメインを別のアカウントに移動するウィザードがポップアップで開始します。
![ドメインのアカウント移行確認画面.png](/images/742ec14ca2683f/migrate2.png)

「続行」を押すと移行先のアカウントIDの入力を求められるので、ここに先ほどコピーしたアカウントIDを2回貼り付けます。
![ドメインのアカウント移行設定画面.png](/images/742ec14ca2683f/migrate3.png)

さらに続けると、ドメインの管理権が移行先のアカウントに移動する旨の注意事項が表示されます。
内容に同意できる場合は2つのチェックボックスにチェックし、送信ボタンを押します。
![ドメインのアカウント移行について同意画面.png](/images/742ec14ca2683f/migrate4.png)

移動に際して問題がなければ以下の画像のように成功し、移行処理が開始されます。
![ドメインのアカウント移行成功画面.png](/images/742ec14ca2683f/migrate5_success.png)

ちなみに、事前に新しいアカウントにウェブサイトの登録を行っていない場合、移行に失敗して以下のような画面が表示されます。
![ドメインのアカウント移行失敗画面.png](/images/742ec14ca2683f/migrate5_failed.png)


ドメインが移行先アカウントに移るまではステータスが移行保留中になります。
![移行ステータス.png](/images/742ec14ca2683f/migration_status.png)

## 4. 移行先アカウントでの受入同意

移行先のアカウントのメールアドレスに、Cloudflareからドメイン受入に関するメールが送信されるので、メールボックスを確認します。
![Cloudflareから送られてくる移管確認メール.png](/images/742ec14ca2683f/activationmail1.png)

リンクを確認すると、以下の画面が表示されます。

ここでドメインと内容に問題がなければ「同意する」ボタンを押します。
::: message
**なお、この画面への遷移は、移行先のSuperAdmin権限を持つユーザーでログインしている必要があります。**
:::
![ドメインのアカウント移行同意画面.png](/images/742ec14ca2683f/activate1.png)

::: message
SuperAdmin以外で「同意する」を押しても、操作を進めることはできません。
以下のエラーメッセージが表示されます。
![移管失敗_管理権限語りないとき.png](/images/742ec14ca2683f/activate2_failed_acception_superadmin_only.png)
:::


SuperAdmin権限のユーザーによって同意されると、無事新しいアカウントにドメインが移行されます。
![移管成功.png](/images/742ec14ca2683f/activate2_success.png)

## 5. ネームサーバーの切り替え

上記まで完了すると、ネームサーバーの切り替えは自動的に行われます。
最大8時間ほどかかるというメールが来ますが、特に問題なければ、その後すぐに完了のメールが送られてきます。
![migration_success_mail2.png](/images/742ec14ca2683f/migration_success_mail2.png)


# 最後に

これで新しいアカウントでドメインとDNSが利用可能になります。
基本的に大きく引っかかるところや難しい部分はなく、スムーズに移行できます。

今回はDNSやCDNレベルでしか利用していないドメインのアカウントの移行を行いました。

:::message
Cloudflare WorkersやCloudflare Pagesなどのサービスを利用した場合、それらは手動で設定が必要だったり、移行がもう少し複雑になる可能性があります。
:::

ゾーンは半手動での移行になるので、取込時の設定にはご注意ください。
